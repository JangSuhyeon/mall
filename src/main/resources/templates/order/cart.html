<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/order/layout-order">
<div-- layout:fragment="content">
    <div class="main">
        <div class="main-container order-page">
            <h2>CART</h2>
            <div class="order-container">
                <div class="order-wrapper">
                    <div class="order-list cart-list">
                        <h2>총 <span class="checked-count total">0</span>개의 상품</h2>
                        <table>
                            <thead>
                            <tr>
                                <th style="width:500px;">상품명</th>
                                <th style="width:145px;">금액</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="art : ${arts}" class="art">
                                <td class="name">
                                    <input th:type="hidden" th:value="${art.getId()}" class="hidden-art-id">
                                    <input type="checkbox" name="checkbox" class="checkbox" th:value="${art.getId()}" checked>
                                    <span class="thumb"><img th:src="@{/images/thumbnail/{fileName}(fileName=${art.getArtImage().getFilename()})}"></span>
                                    <p th:text="${art.getTitle()}"></p>
                                </td>
                                <td class="price"><span th:text="${#numbers.formatDecimal(art.getPrice(), 0, 'COMMA', 0, 'POINT')}"></span>원</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="buy-container">
                    <div class="buy-wrapper">
                        <h2>총 <span class="total">0</span>개의 상품금액</h2>
                        <ul>
                            <li>합계</li>
                            <li><span th:id="totalPrice"></span>원</li>
                        </ul>
                    </div>
                    <input th:type="hidden" th:value="${userId}" class="userId">
                    <button class="buy-btn" th:id="all-choice-btn">전체 작품 주문</button>
                    <button class="choice-btn" th:id="choice-btn">선택 작품 주문</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function(){
            count(); //처음 전체 선택된 상품의 갯수
            sumary();

            $(".checkbox").change(function() { //선택 상태가 바뀔 때 마다 호출
                count();
                sumary();
            });

            function count() { //선택한 상품 갯수
                var init_count = $('input:checkbox[name=checkbox]:checked').length;
                $('.total').text(init_count);
            }

            function sumary() { //선택한 상품 총 금액
                var sum = 0;
                var prices = $('.checkbox').get();
                console.log(prices.length);
                for (var i = 0;i < prices.length; i++){
                    var price = Number(prices[i].value);
                    sum += price;
                }
                sum = String(sum).replace(/\B(?=(\d{3})+(?!\d))/g, ","); //천 단위 콤마 찍기
                $('#totalPrice').text(sum);
            }
        });



        $(document).ready(function(){

            // check box 눌렀을 경우 정보 담아주는 변수
            var cart = {
                buyList : [],
                init : function() {
                    //buyList 초기화
                    this.buyList = [];
                },
                getBuyList : function(obj) {
                    return this.buyList;
                },
                getFindIndex : function(cd) {
                    //배열 중복 검색
                    var fIdx = -1;
                    this.buyList.forEach(function(item, idx, ary) {
                        if(item.code == cd) {
                            fIdx = idx;
                        }
                    });
                    return fIdx;
                },
                addBuyList : function(obj) {
                    var fIdx = this.getFindIndex(obj.code);
                    if(fIdx == -1) {
                        this.buyList.push(obj);
                    } else {
                        this.buyList[fIdx] = obj;
                    }
                    this.render();
                },
                deleteBuyList : function(cd) {
                    this.buyList.splice(this.getFindIndex(cd), 1);
                    this.render();
                },
                getTotalPay : function() {
                    //총 결제금액 계산
                    var totalQty = 0;
                    var totalPrice = 0;

                    this.buyList.forEach(function(item, idx, ary) {
                        totalQty += Number(item.qty);
                        totalPrice += Number(item.price)*Number(item.qty);
                    });
                    return {
                        totalQty : totalQty,
                        totalPrice : totalPrice
                    };
                },
                render : function() {
                    // 주문 table 그리기
                    var order = $('#tbl-order tbody');
                    if(this.buyList.length > 0) {
                        var html = [];
                        this.buyList.forEach(function(item, idx, ary) {
                            html.push([
                                '<tr data-cd="', item.cd ,'">',
                                '<td>', item.title, '</td>',
                                '<td>', item.price, '</td>',
                                '<td>', item.qty, '</td>',
                                '<td>', Number(item.price)*Number(item.qty), '</td>',
                                '</tr>'
                            ].join(''));
                        });
                        order.html(html);

                        // 총 결제금액&수량 table 그리기
                        var total = this.getTotalPay();
                        $('#total-qty').val(total.totalQty);
                        $('#total-amt').val(total.totalPrice);
                        $('#tbl-order').show();

                    } else {
                        // 주문내역 table 숨기기
                        $('#tbl-order').hide();

                        // 주문내역 지우기
                        order.empty();

                        // 총 결제정보 지우기
                        $('#total-qty').val(0);
                        $('#total-amt').val(0);
                    }
                }
            };

            // 수량 클릭 시
            $('.edt-qty').on('change', function() {
                var tr = $(this).closest('tr');
                var code = tr.children('td:eq(1)').text();
                var title = tr.children('td:eq(2)').text();
                var price = Number(tr.children('td:eq(3)').text());
                var qty = Number(tr.children('td:eq(4)').find('input').val());

                // 수량이 0 초과하는 경우 buyList에 추가
                // 수량이 0 이하인 경우 buyList에서 삭제
                if(qty > 0) {
                    var obj = {
                        code : code,
                        title : title,
                        price : price,
                        qty : qty
                    }
                    cart.addBuyList(obj);
                } else {
                    cart.deleteBuyList(code);
                }
                console.log(cart.getBuyList());
            });

            // 삭제 버튼 클릭 시
            $('#btn-delete').on('click', function() {

                var chkList = $('input[name="fruit"]:checked');
                var cd;

                // chcekd 된 product row 삭제
                // order row 삭제
                for(var i = chkList.length-1; i > -1; i--) {
                    cd = chkList.eq(i).closest('tr').find('td:eq(1)').text();
                    chkList.eq(i).closest('tr').remove();
                    cart.deleteBuyList(cd);
                }
            });

        }); //end document ready

        $.fn.serializeObject = function() {
            "use strict";

            var result = {};
            var extend = function(i, element) {
                var node = result[element.name];

                if ('undefined' !== typeof node && node !== null) {
                    if ($.isArray(node)) {
                        node.push(element.value);
                    } else {
                        result[element.name] = [ node, element.value ];
                    }
                } else {
                    result[element.name] = element.value;
                }
            };

            $.each(this.serializeArray(), extend);
            return result;
        };
    </script>
</div-->
</html>